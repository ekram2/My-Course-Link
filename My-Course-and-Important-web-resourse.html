 <!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Important Links - PWA Enabled</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(() => {
        console.log('Service Worker registered!');
      }).catch((err) => {
        console.error('Service Worker registration failed:', err);
      });
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .dark body {
      background-color: #1a202c;
      color: #cbd5e0;
    }
    .light body {
      background-color: #f7fafc;
      color: #1a202c;
    }
    .card {
      background: #2d3748;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      color: #e2e8f0;
      user-select: none;
    }
    .light .card {
      background: #edf2f7;
      color: #2d3748;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .collapsible-content {
      margin-left: 1rem;
      margin-top: 0.5rem;
    }
    .hidden {
      display: none;
    }
    .button {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
    }
    .button-green { background-color: #38a169; color: white; }
    .button-yellow { background-color: #d69e2e; color: white; }
    .button-blue { background-color: #3182ce; color: white; }
    .button-red { background-color: #e53e3e; color: white; }
    .button-gray { background-color: #718096; color: white; }
    .toggle-arrow {
      user-select: none;
    }
  </style>
</head>
<body class="dark">
  <div id="authSection" class="p-6 text-center">
    <h1 class="text-3xl font-bold mb-6">My Important Links</h1>
    <button id="loginBtn" class="button button-blue">Sign in with Google</button>
  </div>

  <div id="mainContent" class="hidden max-w-4xl mx-auto p-4">
    <div class="flex flex-wrap gap-3 mb-6">
      <button id="addLink" class="button button-green">+ Add Link</button>
      <button id="addHeading" class="button button-yellow">+ Add Heading</button>
      <button id="toggleTheme" class="button button-gray">ðŸŒ— Toggle Theme</button>
      <button id="exportJsonBtn" class="button button-blue">ðŸ“¤ Export JSON</button>
      <button id="exportTxtBtn" class="button button-blue">ðŸ“¤ Export TXT</button>
      <label class="cursor-pointer button button-purple relative overflow-hidden">
        ðŸ“¥ Choose File
        <input type="file" id="importFile" accept=".json,.txt" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" />
      </label>
      <button id="logoutBtn" class="button button-red">Logout</button>
    </div>
    <div id="linkContainer" class="space-y-3"></div>
  </div>

  <script>
    // Firebase config - replace with your own
    const firebaseConfig = {
      apiKey: "AIzaSyAN2qRU0gKNNRbsQ1LX688WRHiWP-vQ2hk",
      authDomain: "link-manager-71f12.firebaseapp.com",
      projectId: "link-manager-71f12",
      storageBucket: "link-manager-71f12.appspot.com",
      messagingSenderId: "950228225273",
      appId: "1:950228225273:web:33fc9a192460810d032628"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence()
      .catch((err) => {
        console.warn("Persistence failed:", err.code);
      });

    // DOM elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authSection = document.getElementById("authSection");
    const mainContent = document.getElementById("mainContent");

    // Login/Logout handlers
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };
    logoutBtn.onclick = () => {
      auth.signOut();
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        authSection.classList.add("hidden");
        mainContent.classList.remove("hidden");
        loadAppUI(user.uid, user.displayName);
      } else {
        authSection.classList.remove("hidden");
        mainContent.classList.add("hidden");
      }
    });

    async function loadAppUI(uid, username) {
      const container = document.getElementById("linkContainer");
      const ref = db.collection(`users/${uid}/links`);

      // UI buttons already exist - attach events once:
      if (!loadAppUI.hasEvents) {
        document.getElementById("addLink").onclick = async () => {
          const title = prompt("Link title:");
          const url = prompt("URL:");
          if (title && url) {
            await ref.add({
              type: "link",
              title,
              url: url.startsWith("http") ? url : "https://" + url,
              order: Date.now(),
              clicks: 0
            });
            loadAppUI(uid, username);
          }
        };
        document.getElementById("addHeading").onclick = async () => {
          const text = prompt("Heading title:");
          if (text) {
            await ref.add({
              type: "heading",
              text,
              order: Date.now()
            });
            loadAppUI(uid, username);
          }
        };
        document.getElementById("toggleTheme").onclick = () => {
          if (document.body.classList.contains("dark")) {
            document.body.classList.remove("dark");
            document.body.classList.add("light");
          } else {
            document.body.classList.add("dark");
            document.body.classList.remove("light");
          }
        };
        document.getElementById("exportJsonBtn").onclick = async () => {
          const snapshot = await ref.orderBy("order").get();
          const items = snapshot.docs.map(doc => doc.data());
          const json = JSON.stringify(items, null, 2);
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "links.json";
          a.click();
        };
        document.getElementById("exportTxtBtn").onclick = async () => {
          const snapshot = await ref.orderBy("order").get();
          const items = snapshot.docs.map(doc => doc.data());
          const txt = items.map(i => i.type === "heading" ? `[${i.text}]` : `${i.title}: ${i.url}`).join("\n");
          const blob = new Blob([txt], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "links.txt";
          a.click();
        };
        document.getElementById("importFile").onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const content = await file.text();
          try {
            let imported;
            if (file.name.endsWith(".json")) {
              imported = JSON.parse(content);
            } else {
              imported = parseTxt(content);
            }
            for (const item of imported) {
              delete item.id;
              await ref.add(item);
            }
            loadAppUI(uid, username);
          } catch (err) {
            alert("Import failed: " + err.message);
          }
        };
        loadAppUI.hasEvents = true;
      }

      // Load and render links
      const snapshot = await ref.orderBy("order").get();
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      container.innerHTML = "";
      let currentSection = null;

      items.forEach(item => {
        if (item.type === "heading") {
          const sectionWrapper = document.createElement("div");
          sectionWrapper.className = "space-y-2 border-l-4 pl-3 border-purple-500";

          const headingEl = document.createElement("div");
          headingEl.className = "font-bold text-lg flex justify-between items-center cursor-pointer select-none";
          headingEl.dataset.id = item.id;
          headingEl.dataset.type = "heading";
          headingEl.innerHTML = `
            <span class="collapse-label">${item.text}</span>
            <div class="flex gap-2">
              <button onclick="deleteItem('${item.id}', '${uid}')" class="button button-red">ðŸ—‘</button>
              <span class="toggle-arrow">â–¼</span>
            </div>
          `;

          const contentWrapper = document.createElement("div");
          contentWrapper.className = "ml-4 space-y-2 collapsible-content";

          headingEl.onclick = () => {
            contentWrapper.classList.toggle("hidden");
            headingEl.querySelector('.toggle-arrow').textContent =
              contentWrapper.classList.contains("hidden") ? "â–¶" : "â–¼";
          };

          sectionWrapper.appendChild(headingEl);
          sectionWrapper.appendChild(contentWrapper);
          container.appendChild(sectionWrapper);
          currentSection = contentWrapper;
        } else {
          const linkCard = document.createElement("div");
          linkCard.className = "card flex justify-between items-center";
          linkCard.dataset.id = item.id;
          linkCard.dataset.type = "link";
          linkCard.innerHTML = `
            <div>
              <div class="font-semibold">${item.title}</div>
              <a href="${item.url}" target="_blank" class="text-blue-400 underline">${item.url}</a>
              <div class="text-xs text-gray-400">Clicks: ${item.clicks || 0}</div>
            </div>
            <button onclick="deleteItem('${item.id}', '${uid}')" class="button button-red">ðŸ—‘</button>
          `;
          linkCard.querySelector("a").onclick = () => {
            db.collection(`users/${uid}/links`).doc(item.id).update({
              clicks: (item.clicks || 0) + 1
            });
          };
          if (currentSection) {
            currentSection.appendChild(linkCard);
          } else {
            container.appendChild(linkCard);
          }
        }
      });

      // Setup drag-and-drop with SortableJS
      Sortable.create(container, {
        animation: 150,
        handle: ".card, .font-bold",
        onEnd: () => {
          const newOrder = Array.from(container.querySelectorAll("[data-id]")).map((el, i) => ({
            id: el.dataset.id,
            order: i
          }));
          const batch = db.batch();
          newOrder.forEach(o => {
            batch.update(ref.doc(o.id), { order: o.order });
          });
          batch.commit();
        }
      });
    }

    // Parse TXT import format
    function parseTxt(text) {
      const lines = text.split("\n");
      const result = [];
      for (const line of lines) {
        if (!line.trim()) continue;
        if (line.startsWith("[")) {
          result.push({ type: "heading", text: line.replace(/\[|\]/g, ""), order: Date.now() });
        } else {
          const parts = line.split(": ");
          if (parts.length >= 2) {
            result.push({ type: "link", title: parts[0], url: parts.slice(1).join(": "), order: Date.now(), clicks: 0 });
          }
        }
      }
      return result;
    }

    async function deleteItem(id, uid) {
      await db.collection(`users/${uid}/links`).doc(id).delete();
      const user = auth.currentUser;
      if (user) loadAppUI(user.uid, user.displayName);
    }
  </script>
</body>
</html>
